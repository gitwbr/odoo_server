<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦ä¾‹ç®¡ç† - Odoo SaaS</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="/dashboard/css/style.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard">
        <div class="sidebar">
            <div class="logo">
                ç®¡ç†ç³»çµ±
            </div>
            <ul class="nav-menu">
                <li>
                    <a href="/dashboard/index.html" class="nav-item">
                        â—ˆ æ§åˆ¶å°
                    </a>
                </li>
                <li>
                    <a href="/dashboard/instance.html" class="nav-item active">
                        â—‡ å¯¦ä¾‹ç®¡ç†
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-item">
                        âš¬ ç³»çµ±è¨­ç½®
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-item" onclick="logout()">
                        âŠ— ç™»å‡º
                    </a>
                </li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="welcome">å¯¦ä¾‹ç®¡ç†</div>
                <div class="user-menu">
                    <div class="user-info">
                        <div class="user-avatar">ğŸ‘¤</div>
                        <span id="user-fullname">ç”¨æˆ¶å</span>
                    </div>
                </div>
            </div>

            <div class="instance-card">
              
                <div class="status-info">
                    <div class="info-item">
                        <h3>ç”¨æˆ¶ç­‰ç´š</h3>
                        <p>
                            <span class="status-badge">æ™®é€šç”¨æˆ¶</span>
                        </p>
                    </div>
                    <div class="info-item">
                        <h3>è©¦ç”¨æ™‚é–“</h3>
                        <p>30 å¤©</p>
                    </div>
                    <div class="info-item">
                        <h3>å¯ç”¨å¯¦ä¾‹ç­‰ç´š</h3>
                        <p>æ¸¬è©¦ç‰ˆæœ¬</p>
                    </div>
                    <div class="info-item">
                        <h3>å¯å‰µå»ºæ•¸é‡</h3>
                        <p>1 å€‹</p>
                    </div>
                </div>

                <div style="text-align: center;">
                    <button id="createBtn" class="create-btn" onclick="createInstance()">
                        å‰µå»ºè©¦ç”¨å¯¦ä¾‹
                    </button>
                </div>
            </div>

            <div class="instance-list">
                <h2>æˆ‘çš„å¯¦ä¾‹</h2>
                <div id="instanceContainer">
                    <!-- å®ä¾‹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>
    </div>

    <script src="/dashboard/js/common.js"></script>
    <script>
    // æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹ä¸¦æ§åˆ¶æŒ‰éˆ•
    async function checkUserStatus() {
        try {
            const response = await fetch('/api/user/can_create_instance');
        const data = await response.json();
        
        const createBtn = document.getElementById('createBtn');
        
        if (!data.can_create) {
            createBtn.disabled = true;
            createBtn.title = 'å‰µå»ºå¤±æ•—è«‹é‡è©¦';
        }
            
        } catch (error) {
            console.error('ç²å–ç”¨æˆ¶ä¿¡æ¯å¤±æ•—:', error);
        }
    }

    // å‰µå»ºå¯¦ä¾‹
    async function createInstance() {
        try {
            const createBtn = document.getElementById('createBtn');
            createBtn.disabled = true;
            createBtn.textContent = 'å‰µå»ºä¸­...';

            const response = await fetch('/api/instance/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    version_id: 1  // æ¸¬è©¦ç‰ˆ
                })
            });

            const data = await response.json();
            
            if (response.ok) {
                // å‰µå»ºæˆåŠŸ
                alert('å¯¦ä¾‹å‰µå»ºæˆåŠŸï¼');
                // åˆ·æ–°é é¢
                window.location.reload();
            } else {
                // å‰µå»ºå¤±æ•—
                alert('å‰µå»ºå¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                createBtn.disabled = false;
                createBtn.textContent = 'å‰µå»ºè©¦ç”¨å¯¦ä¾‹';
            }
        } catch (error) {
            console.error('å‰µå»ºå¯¦ä¾‹å¤±æ•—:', error);
            alert('å‰µå»ºå¤±æ•—ï¼šç¶²çµ¡éŒ¯èª¤');
            const createBtn = document.getElementById('createBtn');
            createBtn.disabled = false;
            createBtn.textContent = 'å‰µå»ºè©¦ç”¨å¯¦ä¾‹';
        }
    }

    // é é¢åŠ è¼‰æ™‚æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹
    window.addEventListener('load', checkUserStatus);

    // è·å–å¹¶æ˜¾ç¤ºå®ä¾‹åˆ—è¡¨
    async function loadInstances() {
        try {
            const response = await fetch('/api/instance/list');
            const data = await response.json();
            
            console.log('APIè¿”å›æ•°æ®:', data);
            
            const instanceContainer = document.getElementById('instanceContainer');
            instanceContainer.innerHTML = '';
            
            if (!data.instances || data.instances.length === 0) {
                instanceContainer.innerHTML = `
                    <div class="empty-state">
                        <p>æš«ç„¡å¯¦ä¾‹</p>
                        <button class="create-btn" onclick="createInstance()">å‰µå»ºæ–°å¯¦ä¾‹</button>
                    </div>
                `;
                return;
            }

            // å…ˆæ‰“å°ä¸€ä¸ªå®ä¾‹çš„æ•°æ®çœ‹çœ‹ç»“æ„
            console.log('ç¬¬ä¸€ä¸ªå®ä¾‹æ•°æ®:', data.instances[0]);
            
            data.instances.forEach(instance => {
                // æ„å»ºå®ä¾‹å¡ç‰‡HTML
                instanceContainer.innerHTML += `
                    <div class="instance-main">
                        <div class="instance-header">
                            <div class="name-container">
                                <span class="icon">â—ˆ</span>
                                <h3>${instance.domain || 'æœªå‘½åå¯¦ä¾‹'}</h3>
                                <span class="status-badge">${getStatusText(instance.status)}</span>
                            </div>
                            <div class="actions">
                                <button class="action-btn" onclick="window.open('http://${instance.domain}:${instance.port}', '_blank')" title="è¨ªå•å¯¦ä¾‹">
                                    â†— è¨ªå•
                                </button>
                                <button class="action-btn" onclick="manageInstance(${instance.id})" title="ç®¡ç†å¯¦ä¾‹">
                                    â‹® ç®¡ç†
                                </button>
                                <button class="action-btn" onclick="deleteInstance(${instance.id})" title="åˆªé™¤å¯¦ä¾‹">
                                    Ã— åˆªé™¤
                                </button>
                            </div>
                        </div>

                        <div class="info-grid">
                            <div class="info-item">
                                <h3>Webè¨ªå•</h3>
                                <p>http://${instance.domain}:${instance.port}</p>
                            </div>
                            <div class="info-item">
                                <h3>æ•¸æ“šåº«</h3>
                                <p>Port ${instance.port ? instance.port - 2000 : 'æœªçŸ¥'}</p>
                            </div>
                            <div class="info-item">
                                <h3>ç‰ˆæœ¬</h3>
                                <p>${instance.version_id === 1 ? 'Odoo æ¸¬è©¦ç‰ˆ' : 'Odoo æ­£å¼ç‰ˆ'}</p>
                            </div>
                            <div class="info-item">
                                <h3>å¯¦ä¾‹ID</h3>
                                <p>#${instance.id}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        } catch (error) {
            console.error('åŠ è¼‰å¯¦ä¾‹åˆ—è¡¨å¤±æ•—:', error);
            instanceContainer.innerHTML = `
                <div class="error-state">
                    <p>åŠ è¼‰å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦</p>
                    <button onclick="loadInstances()">é‡æ–°åŠ è¼‰</button>
                </div>
            `;
        }
    }

    // è·å–çŠ¶æ€æ–‡æœ¬
    function getStatusText(status) {
        const statusTexts = {
            0: 'å‰µå»ºä¸­',
            1: 'é‹è¡Œä¸­',
            2: 'å·²åœæ­¢',
            3: 'å·²éæœŸ',
            4: 'å‰µå»ºå¤±æ•—'
        };
        return statusTexts[status] || 'æœªçŸ¥';
    }

    // é¡µé¢åŠ è½½æ—¶è·å–å®ä¾‹åˆ—è¡¨
    document.addEventListener('DOMContentLoaded', loadInstances);

    // åˆ é™¤å®ä¾‹
    async function deleteInstance(instanceId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¯¦ä¾‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚')) {
            return;
        }

        try {
            const response = await fetch(`/api/instance/delete/${instanceId}`, {
                method: 'DELETE'
            });

            const data = await response.json();
            
            if (response.ok && data.message) {
                await loadInstances();
                showMessage(data.message, 'success');
            } else {
                throw new Error(data.error || 'åˆªé™¤å¤±æ•—');
            }
        } catch (error) {
            console.error('åˆªé™¤å¯¦ä¾‹å¤±æ•—:', error);
            showMessage(error.message, 'error');
        }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
    function showMessage(message, type = 'success') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = message;
        
        document.body.appendChild(messageDiv);
        
        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            messageDiv.remove();
        }, 3000);
    }

    // æ·»åŠ æ¶ˆæ¯æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
    .message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        animation: slideIn 0.3s ease;
        z-index: 1000;
    }

    .message.success {
        background: #10B981;
    }

    .message.error {
        background: #EF4444;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    `;

    document.head.appendChild(style);
    </script>
</body>
</html> 